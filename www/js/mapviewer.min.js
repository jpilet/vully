
this.Utils={assert:function(condition){if(!condition){throw('Assertion failed.');}},objectToString:function(o){if(typeof o==='object'){var str='{';for(var i in o){str+=i+': '+Utils.objectToString(o[i])+',';}
str+='}';return str;}else{return''+o;}},invert3x3Matrix:function(a){var a00=a[0],a01=a[1],a02=a[2],a10=a[3],a11=a[4],a12=a[5],a20=a[6],a21=a[7],a22=a[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;if(!det){return null;}
det=1.0/det;var out=[];out[0]=b01*det;out[1]=(-a22*a01+a02*a21)*det;out[2]=(a12*a01-a02*a11)*det;out[3]=b11*det;out[4]=(a22*a00-a02*a20)*det;out[5]=(-a12*a00+a02*a10)*det;out[6]=b21*det;out[7]=(-a21*a00+a01*a20)*det;out[8]=(a11*a00-a01*a10)*det;return out;},multiply3x3MatrixWithVector:function(A,b){var r=[0,0,0];for(var i=0;i<3;++i){r[i]=A[i*3+0]*b[0]+A[i*3+1]*b[1]+A[i*3+2]*b[2];}
return r;},distance:function(a,b){var dx=a.x-b.x;var dy=a.y-b.y;return Math.sqrt(dx*dx+dy*dy);},eventPosInElementCoordinates:function(event,element){var rect=element.getBoundingClientRect();var r={x:(event.clientX-rect.left)*(element.width/element.offsetWidth),y:(event.clientY-rect.top)*(element.height/element.offsetHeight)};Utils.assert(!isNaN(r.x)&&!isNaN(r.y));return r;},};window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60);};})();(function(window,document){var prefix="",_addEventListener,onwheel,support;if(window.addEventListener){_addEventListener="addEventListener";}else{_addEventListener="attachEvent";prefix="on";}
support="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll";window.addWheelListener=function(elem,callback,useCapture){_addWheelListener(elem,support,callback,useCapture);if(support=="DOMMouseScroll"){_addWheelListener(elem,"MozMousePixelScroll",callback,useCapture);}};function _addWheelListener(elem,eventName,callback,useCapture){elem[_addEventListener](prefix+eventName,support=="wheel"?callback:function(originalEvent){!originalEvent&&(originalEvent=window.event);var event={originalEvent:originalEvent,target:originalEvent.target||originalEvent.srcElement,type:"wheel",deltaMode:originalEvent.type=="MozMousePixelScroll"?0:1,deltaX:0,delatZ:0,pageX:originalEvent.pageX,pageY:originalEvent.pageY,clientX:originalEvent.clientX,clientY:originalEvent.clientY,preventDefault:function(){originalEvent.preventDefault?originalEvent.preventDefault():originalEvent.returnValue=false;}};if(support=="mousewheel"){event.deltaY=-1/40*originalEvent.wheelDelta;originalEvent.wheelDeltaX&&(event.deltaX=-1/40*originalEvent.wheelDeltaX);}else{event.deltaY=originalEvent.detail;}
return callback(event);},useCapture||false);}})(window,document);if(!window.requestAnimationFrame){window.requestAnimationFrame=(function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,1000/60);};})();};function AffineTransform(transform){if(transform instanceof Array&&transform.length==6){this.matrix=transform.slice(0);}else if(transform&&transform.matrix){this.matrix=transform.matrix.slice(0);}else{this.matrix=[1,0,0,0,1,0];}}
AffineTransform.prototype.transform=function(x_,y_){var x=(typeof(x_)=="object"?x_.x:x_);var y=(typeof(x_)=="object"?x_.y:y_);return{x:this.matrix[0]*x+this.matrix[1]*y+this.matrix[2],y:this.matrix[3]*x+this.matrix[4]*y+this.matrix[5],};};AffineTransform.prototype.inverseTransform=function(x_,y_){var x=(typeof(x_)=="object"?x_.x:x_);var y=(typeof(x_)=="object"?x_.y:y_);var a=this.matrix[0];var b=this.matrix[1];var c=this.matrix[3];var d=this.matrix[4];var invdet=1/(a*d-b*c);var u=x-this.matrix[2];var v=y-this.matrix[5];return{x:(d*u-b*v)*invdet,y:(-c*u+a*v)*invdet,};};AffineTransform.prototype.scale=function(scaleFactor){this.matrix[0]*=scaleFactor;this.matrix[1]*=scaleFactor;this.matrix[3]*=scaleFactor;this.matrix[4]*=scaleFactor;};AffineTransform.prototype.canvasSetTransform=function(canvas){var t=this.matrix;canvas.setTransform(t[0],t[3],t[1],t[4],t[2],t[5]);};function PinchZoom(element,transformChanged,width,height){this.ongoingTouches={};this.transform=new AffineTransform();this.transformChanged=transformChanged;this.worldWidth=width||1;this.worldHeight=height||1;this.lastMouseDown=0;this.lastTouchDown=0;this.lastTouchDownPos={x:-1,y:-1};this.minScale=0;var t=this;var e=element;e.addEventListener("touchstart",function(event){t.handleStart(event);},false);e.addEventListener("touchend",function(event){t.handleEnd(event);},false);e.addEventListener("touchcancel",function(event){t.handleEnd(event);},false);e.addEventListener("touchmove",function(event){t.handleMove(event);},false);e.addEventListener("mousedown",function(event){t.handleMouseDown(event);},false);e.addEventListener("mousemove",function(event){t.handleMouseMove(event);},false);e.addEventListener("mouseup",function(event){t.handleMouseUp(event);},false);addWheelListener(element,function(event){t.handleMouseWheel(event);});element.pinchZoomInstance=this;this.element=element;}
PinchZoom.prototype.eventElement=function(event){if(event.srcElement){return event.srcElement;}
else if(event.currentTarget){return event.currentTarget;}
else{return undefined;}};PinchZoom.prototype.setTransform=function(transform){var newTransform=new AffineTransform(transform);if(!this.checkAndApplyTransform(newTransform)){return;}
var viewerPos=Utils.eventPosInElementCoordinates(event,this.eventElement(event));if(this.ongoingTouches.mouse){var viewerPos=this.ongoingTouches.mouse.startViewerPos;this.ongoingTouches.mouse.startWorldPos=this.worldPosFromViewerPos(viewerPos.x,viewerPos.y);}else{this.ongoingTouches={};}};PinchZoom.prototype.worldPosFromViewerPos=function(x,y){return this.transform.inverseTransform(x,y);};PinchZoom.prototype.viewerPosFromWorldPos=function(x,y){return this.transform.transform(x,y);};PinchZoom.prototype.isMoving=function(){var count=0;for(var i in this.ongoingTouches){if(this.ongoingTouches[i]){++count;}}
return count>0;};PinchZoom.prototype.handleDoubleClic=function(viewerPos){var constraints=[{viewer:viewerPos,world:this.worldPosFromViewerPos(viewerPos.x,viewerPos.y),}];this.transform.scale(2);this.processConstraints(constraints);};PinchZoom.prototype.handleMouseDown=function(event){var viewerPos=Utils.eventPosInElementCoordinates(event,this.element);var now=new Date().getTime();if((now-this.lastMouseDown)<100){this.handleDoubleClic(viewerPos);this.ongoingTouches.mouse=undefined;}else{this.ongoingTouches.mouse={startWorldPos:this.worldPosFromViewerPos(viewerPos.x,viewerPos.y),startViewerPos:viewerPos,};}
this.lastMouseDown=now;};PinchZoom.prototype.handleMouseUp=function(event){event.preventDefault();this.handleMouseMove(event);this.ongoingTouches.mouse=undefined;};PinchZoom.prototype.handleMouseMove=function(event){event.preventDefault();if(this.ongoingTouches.mouse){this.ongoingTouches.mouse.currentViewerPos=Utils.eventPosInElementCoordinates(event,this.element);var constraints=[{viewer:this.ongoingTouches.mouse.currentViewerPos,world:this.ongoingTouches.mouse.startWorldPos,}];this.processConstraints(constraints);}};PinchZoom.prototype.handleMouseWheel=function(event){event.preventDefault();var viewerPos=Utils.eventPosInElementCoordinates(event,this.element);var constraints=[{viewer:viewerPos,world:this.worldPosFromViewerPos(viewerPos.x,viewerPos.y),}];var scaleFactor=1.0-Math.max(-.2,Math.min(.2,event.deltaY/20.0));this.transform.scale(scaleFactor);this.processConstraints(constraints);};PinchZoom.prototype.handleStart=function(event){event.preventDefault();if(event.touches.length==1){var now=new Date().getTime();var delta=(now-this.lastTouchDown);var viewerPos=Utils.eventPosInElementCoordinates(event.touches[0],this.element);var dist=Utils.distance(viewerPos,this.lastTouchDownPos);if(delta<300&&dist<100){this.handleDoubleClic(viewerPos);}
this.lastTouchDown=now;this.lastTouchDownPos=viewerPos;}
var touches=event.changedTouches;for(var i=0;i<touches.length;i++){var viewerPos=Utils.eventPosInElementCoordinates(touches[i],this.element);this.ongoingTouches[touches[i].identifier]={startWorldPos:this.worldPosFromViewerPos(viewerPos.x,viewerPos.y),startViewerPos:viewerPos,};}};PinchZoom.prototype.handleEnd=function(event){event.preventDefault();this.ongoingTouches={};this.handleMove(event);};PinchZoom.prototype.handleMove=function(event){event.preventDefault();var touches=event.touches;var constraints=[];for(var i=0;i<touches.length;i++){if(!this.ongoingTouches[touches[i].identifier]){var viewerPos=Utils.eventPosInElementCoordinates(touches[i],this.element);this.ongoingTouches[touches[i].identifier]={startWorldPos:this.worldPosFromViewerPos(viewerPos.x,viewerPos.y),startViewerPos:viewerPos,};}
var touch=this.ongoingTouches[touches[i].identifier];constraints.push({viewer:Utils.eventPosInElementCoordinates(touches[i],this.element),world:touch.startWorldPos,});}
this.processConstraints(constraints);};PinchZoom.prototype.processConstraints=function(constraints){var newTransform=new AffineTransform(this.transform.matrix);var T=newTransform.matrix;if(constraints.length>=2){var wx1=constraints[0].world.x;var wy1=constraints[0].world.y;var wx2=constraints[1].world.x;var wy2=constraints[1].world.y;var vx1=constraints[0].viewer.x;var vy1=constraints[0].viewer.y;var vx2=constraints[1].viewer.x;var vy2=constraints[1].viewer.y;var AtA00=wx1*wx1+wx2*wx2+wy1*wy1+wy2*wy2;var AtA10=wx1+wx2;var AtA20=wy1+wy2;var Ainv=Utils.invert3x3Matrix([AtA00,AtA10,AtA20,AtA10,2,0,AtA20,0,2]);var AtB=[vx1*wx1+vx2*wx2+vy1*wy1+vy2*wy2,vx1+vx2,vy1+vy2];var r=Utils.multiply3x3MatrixWithVector(Ainv,AtB);T[0]=T[4]=r[0];T[2]=r[1];T[5]=r[2];this.enforceConstraints(newTransform);var c={world:{x:(constraints[0].world.x+constraints[1].world.x)/2,y:(constraints[0].world.y+constraints[1].world.y)/2,},viewer:{x:(constraints[0].viewer.x+constraints[1].viewer.x)/2,y:(constraints[0].viewer.y+constraints[1].viewer.y)/2,}};T[2]=c.viewer.x-(T[0]*c.world.x+T[1]*c.world.y);T[5]=c.viewer.y-(T[3]*c.world.x+T[4]*c.world.y);}else if(constraints.length==1){this.enforceConstraints(newTransform);var c=constraints[0];T[2]=c.viewer.x-(T[0]*c.world.x+T[1]*c.world.y);T[5]=c.viewer.y-(T[3]*c.world.x+T[4]*c.world.y);}
var tiledViewer=this;this.checkAndApplyTransform(newTransform);};PinchZoom.prototype.enforceConstraints=function(newTransform){var T=newTransform.matrix;var boundScaleX=this.element.width/this.worldWidth;var boundScaleY=this.element.height/this.worldHeight;var scaleBound=Math.min(boundScaleX,boundScaleY);var scale=T[0];var scaleFactor=1.0;if(scale<scaleBound){scaleFactor=scaleBound/scale;}
if(this.minScale>0){var maxScale=this.element.width/this.minScale;if(scale>maxScale){scaleFactor=maxScale/scale;}}
T[0]=T[4]=scale*scaleFactor;T[2]*=scaleFactor;T[5]*=scaleFactor;if(T[2]>0)T[2]=0;if(T[5]>0)T[5]=0;var bottomright=newTransform.transform(this.worldWidth,this.worldHeight);if(bottomright.x<this.element.width){var center=(T[2]==0?.5:1);T[2]+=center*(this.element.width-bottomright.x);}
if(bottomright.y<this.element.height){var center=(T[5]==0?.5:1);T[5]+=center*(this.element.height-bottomright.y);}};PinchZoom.prototype.checkAndApplyTransform=function(newTransform){newTransform=newTransform||this.transform;this.enforceConstraints(newTransform);if(this.transform!==newTransform){this.transform=newTransform;if(this.transformChanged){this.transformChanged(this.transform);}}};function CanvasTilesRenderer(params){this.params=(params!=undefined?params:{});this.canvas=params.canvas;this.canvas.canvasTilesRenderer=this;if(!("tileSize"in this.params))this.params.tileSize=256;if(!("url"in this.params)){this.params.url=function(scale,x,y){return"http://a.tile.openstreetmap.org/"+scale+'/'+x+'/'+y+'.png';};}
this.params.width=this.params.width||1;this.params.height=this.params.height||1;this.params.minScale=this.params.minScale||0;if(!this.params.maxNumCachedTiles)this.params.maxNumCachedTiles=64;if(!this.params.maxSimultaneousLoads)this.params.maxSimultaneousLoads=3;this.params.downgradeIfSlowerFPS=params.downgradeIfSlowerFPS||20;this.tiles={};this.numLoading=0;this.loadQueue=[];this.canvasWidth=-1;this.canvasHeight=-1;if(params.debug){this.debug=function(msg){console.log(msg);}}else{this.debug=function(msg){};}
this.inDraw=true;this.numDraw=0;this.numCachedTiles=0;this.disableResize=false;this.lastRefreshRequest=-1;var t=this;this.pinchZoom=new PinchZoom(t.canvas,function(){t.location=t.getLocation();if(t.params.onLocationChange){t.params.onLocationChange(t);}
if(t.params.debug){t.debug('location: w:'+t.canvas.width
+' h:'+t.canvas.height
+' x:'+t.location.x+' y:'+t.location.y
+' s:'+t.location.scale);}
t.refresh();},this.params.width,this.params.height);this.pinchZoom.minScale=this.params.minScale;this.inDraw=false;var location=params.initialLocation||{x:(this.params.width||1)/2,y:(this.params.height||1)/2,scale:(this.params.width||1)};this.setLocation(location);}
CanvasTilesRenderer.prototype.getLocation=function(){var left=this.pinchZoom.worldPosFromViewerPos({x:0,y:this.canvas.height/2});var right=this.pinchZoom.worldPosFromViewerPos({x:this.canvas.width,y:this.canvas.height/2});return{x:(left.x+right.x)/2,y:(left.y+right.y)/2,scale:Utils.distance(right,left)};};CanvasTilesRenderer.prototype.setLocation=function(location){if(isNaN(location.x)||isNaN(location.y)||isNaN(location.scale)){throw('invalid location');}
var canvas=this.canvas;var ratio=[location['vx']||.5,location['vy']||.5,];var x_pos=canvas.width*ratio[0];var y_pos=canvas.height*ratio[1];var constraints=[{viewer:{x:x_pos-canvas.width/2,y:y_pos},world:{x:location.x-location.scale/2,y:location.y}},{viewer:{x:x_pos+canvas.width/2,y:y_pos},world:{x:location.x+location.scale/2,y:location.y}},];this.location=location;this.pinchZoom.processConstraints(constraints);};CanvasTilesRenderer.prototype.refresh=function(){var t=this;if(t.lastRefreshRequest==t.numDraw){return;}
t.lastRefreshRequest=t.numDraw;window.requestAnimationFrame(function(){t.draw(t.canvas);});};CanvasTilesRenderer.prototype.resizeCanvas=function(){if(this.disableResize){return;}
var canvas=this.canvas;var density=(this.params.forceDevicePixelRatio||window.devicePixelRatio||1);var factor=(this.params.downsampleDuringMotion&&this.pinchZoom.isMoving())?density/2:density;var initialClientWidth=canvas.clientWidth;var initialClientHeight=canvas.clientHeight;var newWidth=Math.floor(canvas.clientWidth*factor);var newHeight=Math.floor(canvas.clientHeight*factor);if(newWidth!=0&&newHeight!=0&&(Math.abs(canvas.width-newWidth)>3||Math.abs(canvas.height-newHeight)>3)){canvas.width=newWidth;canvas.height=newHeight;}
if(canvas.width!=this.canvasWidth||canvas.height!=this.canvasHeight){this.canvasWidth=canvas.width;this.canvasHeight=canvas.height;this.setLocation(this.location);}
if(initialClientWidth!=canvas.clientWidth||initialClientHeight!=canvas.clientHeight){this.disableResize=true;this.debug('Disabling resize :(');}};CanvasTilesRenderer.prototype.draw=function(){if(this.inDraw){return;}
this.inDraw=true;var startTimestamp=new Date().getTime();var canvas=this.canvas;var pinchZoom=this.pinchZoom;this.resizeCanvas();pinchZoom.checkAndApplyTransform();var cornersPix=[{x:0,y:0},{x:canvas.width,y:0},{x:canvas.width,y:canvas.height},{x:0,y:canvas.height},];var cornersWorld=[];for(var i=0;i<4;++i){cornersWorld.push(pinchZoom.worldPosFromViewerPos(cornersPix[i]));}
var bboxTopLeft=cornersWorld.reduce(function(a,b){return{x:Math.min(a.x,b.x),y:Math.min(a.y,b.y)};},cornersWorld[0]);var bboxBottomRight=cornersWorld.reduce(function(a,b){return{x:Math.max(a.x,b.x),y:Math.max(a.y,b.y)};},cornersWorld[0]);var numTiles=canvas.width/this.params.tileSize;var targetUnitPerTile=(bboxBottomRight.x-bboxTopLeft.x)/numTiles;var scale=Math.max(0,Math.ceil(-Math.log(targetUnitPerTile)/Math.LN2));var actualUnitPerTile=1/(1<<scale);var getTileX=function(unitX){return Math.floor(unitX*(1<<scale));};var getTileY=function(unitY){return getTileX(unitY);};var firstTileX=getTileX(Math.max(0,bboxTopLeft.x));var firstTileY=getTileY(Math.max(0,bboxTopLeft.y));var lastTileX=getTileX(Math.min(this.params.width,bboxBottomRight.x));var lastTileY=getTileY(Math.min(this.params.height,bboxBottomRight.y));var context=canvas.getContext('2d');this.clearBorder(context);Utils.assert(firstTileY!=undefined);var zoom=1.0/(1<<scale);var tileGeometry={origin:pinchZoom.viewerPosFromWorldPos(firstTileX*zoom,firstTileY*zoom),delta:pinchZoom.viewerPosFromWorldPos((firstTileX+1)*zoom,(firstTileY+1)*zoom),firstTileX:firstTileX,firstTileY:firstTileY};tileGeometry.delta.x=Math.round(tileGeometry.delta.x-tileGeometry.origin.x);tileGeometry.delta.y=Math.round(tileGeometry.delta.y-tileGeometry.origin.y);tileGeometry.origin.x=Math.round(tileGeometry.origin.x);tileGeometry.origin.y=Math.round(tileGeometry.origin.y);for(var tileY=firstTileY;tileY<=lastTileY;++tileY){for(var tileX=firstTileX;tileX<=lastTileX;++tileX){this.renderTile(scale,tileX,tileY,context,tileGeometry);}}
if(0){if(this.pinchZoom.ongoingTouches.mouse&&this.pinchZoom.ongoingTouches.mouse.currentViewerPos){var pos=this.pinchZoom.ongoingTouches.mouse.currentViewerPos;context.beginPath();context.arc(pos.x,pos.y,20,0,2*Math.PI,false);context.fillStyle='green';context.fill();}}
this.processQueue();this.limitCacheSize();var moving=this.pinchZoom.isMoving();if(moving){if(this.moveEndTimeout!=undefined){window.clearTimeout(this.moveEndTimeout);}
var t=this;this.moveEndTimeout=setTimeout(function(){t.moveEndTimeout=undefined;t.refresh();},100);}
this.inDraw=false;++this.numDraw;var endTimestamp=new Date().getTime();var renderingTime=(endTimestamp-startTimestamp);if(renderingTime>(1000/this.params.downgradeIfSlowerFPS)){this.params.downsampleDuringMotion=true;}
if(this.params.debug){var debugLocation=this.getLocation();this.debug('Draw at '
+debugLocation.x+', '+debugLocation.y+' scale: '+debugLocation.scale
+' rendering time:'+renderingTime
+' w:'+canvas.width+' h:'+canvas.height);}};CanvasTilesRenderer.prototype.renderTile=function(scale,tileX,tileY,context,tileGeometry){var left=tileGeometry.origin.x
+tileGeometry.delta.x*(tileX-tileGeometry.firstTileX);var top=tileGeometry.origin.y
+tileGeometry.delta.y*(tileY-tileGeometry.firstTileY);if(left>=this.canvas.width||top>=this.canvas.height){return;}
for(var upLevel=0;upLevel<=scale&&upLevel<5;++upLevel){var upTileX=tileX>>upLevel;var upTileY=tileY>>upLevel;var tile=this.getTile(scale-upLevel,upTileX,upTileY,1-upLevel*.15);if(tile&&tile.image&&tile.image.complete&&tile.image.width>0&&tile.image.height>0){var skipX=tileX-(upTileX<<upLevel);var skipY=tileY-(upTileY<<upLevel);var size=this.params.tileSize>>upLevel;var texCoordX=skipX*size;var texCoordY=skipY*size;var texWidth=Math.min(size,tile.image.width-skipX*size);var texHeight=Math.min(size,tile.image.height-skipY*size);var width=tileGeometry.delta.x*(texWidth/size);var height=tileGeometry.delta.y*(texHeight/size);try{context.drawImage(tile.image,texCoordX,texCoordY,texWidth,texHeight,left,top,width,height);}catch(e){this.debug('drawImage failed: '+e.message);}
return;}}};CanvasTilesRenderer.prototype.getTile=function(scale,x,y,priority){var key=scale+","+x+","+y;if(key in this.tiles){var tile=this.tiles[key];if(tile.lastDrawRequest==this.numDraw){tile.priority+=priority;}else{tile.lastDrawRequest=this.numDraw;tile.priority=priority;}
return tile;}
if(typeof(this.params.url)=="function"){var url=this.params.url(scale,x,y);}else{var url=this.params.url.replace("$x",''+x).replace("$y",''+y).replace("$scale",''+scale);}
return this.queueTileRequest(key,url,priority);};CanvasTilesRenderer.prototype.queueTileRequest=function(key,url,priority){var tile={lastDrawRequest:this.numDraw,priority:priority,state:"queue"};Utils.assert(tile.priority!=undefined);this.loadQueue.push({key:key,url:url,tile:tile});this.tiles[key]=tile;return tile;};CanvasTilesRenderer.prototype.processQueue=function(){var queue=this.loadQueue;if(this.numLoading<this.params.maxSimultaneousLoads&&queue.length>0){this.loadQueue.sort(function(a,b){if(a.tile.lastDrawRequest==b.tile.lastDrawRequest){return a.tile.priority-b.tile.priority;}
return a.tile.lastDrawRequest-b.tile.lastDrawRequest;});}
while(this.numLoading<this.params.maxSimultaneousLoads&&queue.length>0){var query=this.loadQueue.pop();if((this.numDraw-query.tile.lastDrawRequest)<3){this.numLoading++;var image=new Image();image.src=query.url;query.tile.state="loading";query.tile.image=image;var f=(function(t,image,query){image.onload=function(){t.numLoading--;t.numCachedTiles++;query.tile.state="loaded";if(!t.pinchZoom.isMoving()){t.refresh();}};image.onerror=function(){t.numLoading--;query.tile.state="failed";delete query.tile.image;console.log('Failed to load: '+query.url);t.processQueue();};})(this,image,query);}else{delete this.tiles[query.key];}}};CanvasTilesRenderer.prototype.limitCacheSize=function(){if(this.numCachedTiles<=this.params.maxNumCachedTiles){return;}
var cache=[];for(var key in this.tiles){var tile=this.tiles[key];if(tile.image&&tile.lastDrawRequest!=this.numDraw){cache.push(key);}}
var t=this;cache.sort(function(a,b){return t.tiles[a].lastDrawRequest-t.tiles[b].lastDrawRequest;});var numToRemove=cache.length-this.params.maxNumCachedTiles;for(var i=0;i<numToRemove;++i){var key=cache[i];delete this.tiles[key];this.numCachedTiles--;}};CanvasTilesRenderer.prototype.clearBorder=function(context){var canvas=this.canvas;var topLeft=this.pinchZoom.viewerPosFromWorldPos(0,0);var bottomRight=this.pinchZoom.viewerPosFromWorldPos(this.params.width,this.params.height);context.fillStyle='white';if(topLeft.x>0){context.fillRect(0,0,Math.floor(topLeft.x),canvas.height);}
if(topLeft.y>0){context.fillRect(0,0,canvas.width,Math.floor(topLeft.y));}
if(bottomRight.x<canvas.width){context.fillRect(bottomRight.x,0,canvas.width-bottomRight.x,canvas.height);}
if(bottomRight.y<canvas.height){context.fillRect(0,bottomRight.y,canvas.width,canvas.height-bottomRight.y);}};window.addEventListener("load",function load(event){window.removeEventListener("load",load,false);MapHtmlInterface.init();},false);var MapHtmlInterface={paramNames:["url","width","height","debug","minScale","tileSize","maxNumCachedTiles","maxSimultaneousLoads","downgradeIfSlowerFPS","initialLocation","onLocationChange"],stringParamNames:{"url":true},init:function(){var maps=document.querySelectorAll("[data-map-url]");for(var i=0;i<maps.length;++i){MapHtmlInterface.initMap(maps[i]);}},initMap:function(container){var canvas=document.createElement('canvas');canvas.style.width="100%";canvas.style.height="100%";canvas.innerHtml="Your browser does not support CANVAS.";container.insertBefore(canvas,container.childNodes[0]);var params={"canvas":canvas,};var attr=function(name){var attributeName="data-map-"+name;if(container.hasAttribute(attributeName)){params[name]=container.getAttribute(attributeName);if(!(name in MapHtmlInterface.stringParamNames)){eval("params[name] = ("+params[name]+');');}}}
for(var i in MapHtmlInterface.paramNames){attr(MapHtmlInterface.paramNames[i]);}
if(typeof(params.onLocationChange)=="function"){var userCallback=params.onLocationChange;params.onLocationChange=function(canvasRenderer){MapHtmlInterface.placeMarks(container,canvasRenderer);userCallback(canvasRenderer);}}else{params.onLocationChange=function(canvasRenderer){MapHtmlInterface.placeMarks(container,canvasRenderer);}}
var canvasTilesRenderer=new CanvasTilesRenderer(params);window.addEventListener("resize",function(){canvasTilesRenderer.refresh();},false);},placeMarks:function(container,canvasTilesRenderer){var worldToElement=function(x,y){var canvas=canvasTilesRenderer.params.canvas;var canvasPos=canvasTilesRenderer.pinchZoom.viewerPosFromWorldPos(x,y);return{x:canvasPos.x*(canvas.offsetWidth/canvas.width),y:canvasPos.y*(canvas.offsetHeight/canvas.height)};}
var splitArrayArg=function(asString){if(asString){return asString.split(",").map(parseFloat);}else{return[];}}
for(var i=0;i<container.childNodes.length;++i){var child=container.childNodes[i];if("hasAttribute"in child&&child.hasAttribute("data-map-pos")){var pos=splitArrayArg(child.getAttribute("data-map-pos"));if(pos.length!=2){throw("data-map-pos syntax is: \"x,y\", for example: data-map-pos=\".1,.2\"");}
var worldPos={x:pos[0],y:pos[1]};var anchorPos=worldToElement(worldPos);var anchor={x:0,y:0};var anchorParam=splitArrayArg(child.getAttribute("data-map-anchor"));if(!isNaN(anchorParam[0])){anchor.x=anchorParam[0];}
if(!isNaN(anchorParam[1])){anchor.y=anchorParam[1];}
var topLeft={x:anchorPos.x-anchor.x*child.offsetWidth,y:anchorPos.y-anchor.y*child.offsetHeight,};child.style.position="absolute";child.style.left=Math.round(topLeft.x)+"px";child.style.top=Math.round(topLeft.y)+"px";if(child.hasAttribute("data-map-width")){var width=parseFloat(child.getAttribute("data-map-width"));var topRight=worldToElement(worldPos.x+width,worldPos.y);child.style.width=(topRight.x-topLeft.x)+"px";}
if(child.hasAttribute("data-map-height")){var height=parseFloat(child.getAttribute("data-map-height"));var bottomLeft=worldToElement(worldPos.x,worldPos.y+height);child.style.height=(bottomLeft.y-topLeft.y)+"px";}}}},};